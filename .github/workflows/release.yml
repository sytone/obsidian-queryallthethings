name: Release Obsidian Plugin
on:
  push:
    # Sequence of patterns matched against refs/tags
    # Note: Glob patterns are used for broad matching. Strict format validation
    # is performed in the "Validate Tag Format" step of the workflow.
    tags:
      - '*.*.*' # Matches three-part version tags (e.g., 1.0.0, 1.3.2, 20.15.10)

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  ACTIONS_RUNNER_DEBUG : true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Validate Tag Format ğŸ”
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if ! [[ "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Tag '$TAG' does not match semantic versioning format (X.Y.Z)"
            exit 1
          fi
          echo "âœ… Tag '$TAG' is valid semantic version"

      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

      - name: Use Node.js âš™ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup PNPM âš™ï¸
        uses: pnpm/action-setup@v2
        with:
          version: 9

      # Get the version number and put it in a variable
      # - name: Get Version
      #   id: version
      #   run: |
      #     echo "::set-output name=tag::$(git describe --abbrev=0)"

      - name: Get Version ğŸ·ï¸
        id: version
        run: |
          echo "tag=$(git describe --abbrev=0)" >> $GITHUB_OUTPUT

      # Build the plugin
      - name: Build Plugin ğŸ—ï¸
        id: build
        run: |
          pnpm install
          pnpm run build

      # Package the required files into a zip
      - name: Package Plugin ğŸ“¦
        run: |
          mkdir ${{ github.event.repository.name }}
          cp ./dist/main.js ./dist/manifest.json ./dist/styles.css README.md ${{ github.event.repository.name }}
          zip -r ${{ github.event.repository.name }}.zip ${{ github.event.repository.name }}

      # Package the docs/vault files into a zip
      - name: Package Vault ğŸ“¦
        run: |
          mkdir ${{ github.event.repository.name }}/vault
          cp -R docs/. ${{ github.event.repository.name }}/vault
          zip -r ${{ github.event.repository.name }}.vault.zip ${{ github.event.repository.name }}/vault

      - name: Build Changelog ğŸš€
        id: get_release_notes
        uses: yashanand1910/standard-release-notes@v1.2.1
        with:
          changelog_path: ./CHANGELOG.md # Optional
          version: ${{ github.ref }} # Required

      - name: Show Release Notes ğŸ·ï¸
        run: |
          echo "${{ steps.get_release_notes.outputs.release_notes }}"

      - name: Release Plugin ğŸš€
        uses: ncipollo/release-action@v1
        id: release_plugin
        with:
          artifacts: './${{ github.event.repository.name }}.zip,./${{ github.event.repository.name }}.vault.zip,./dist/main.js,./dist/manifest.json,./dist/styles.css'
          name: ${{ github.ref_name }}
          draft: true
          body: |
            # Query All The Things (qatt) v${{ github.ref_name }} Release :tada:
            
            You can download the documentation and example vault to open in obsidian to see the queries in action <A href='https://github.com/sytone/obsidian-queryallthethings/releases/latest/download/obsidian-queryallthethings.vault.zip'>here</a>.
            
            ${{ steps.get_release_notes.outputs.release_notes }}
          generateReleaseNotes: true
          discussionCategory: announcements
